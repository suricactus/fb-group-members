<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta property="og:image" content="http://i.imgur.com/YRTl2GG.png">
    <meta property="og:title" content="FB групи и сечения">
    <meta property="og:description" content="Какво е сечението на хората, които едновременно харесват „Курволяци“, „Путин“ и „Дочуто в София“?" />
    <title>FB групи и сечения</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/css/bootstrap.min.css" integrity="sha384-rwoIResjU2yc3z8GV/NPeZWAv56rSmLldC3R/AZzGRnGxQQKnKkoFVhFQhNUwEyJ" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.3/css/select2.min.css">
    <script src="https://code.jquery.com/jquery-3.1.1.slim.min.js" integrity="sha384-A7FZj7v+d/sdmMqp/nOQwliLvUsJfDHW+k9Omg/a/EheAdgtzNs3hpfag6Ed950n" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tether/1.4.0/js/tether.min.js" integrity="sha384-DztdAPBWPRXSA/3eYEEUWrWCy7G5KFbe8fFjk5JAIxUYHKkDx6Qin1DkWx51bBrb" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/js/bootstrap.min.js" integrity="sha384-vBWWzlZJ8ea9aCX4pEW3rVHjgjt7zpkNpZk+02D9phzyeVkE+jo0ieGizqPLForn" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.7.1/d3.min.js" integrity="sha256-4l+MLGOR7l/v3VuQiGgchPcP2mEDT/9zq+JTLqBdFL8=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.3/js/select2.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.3/js/i18n/bg.js"></script>
    <script src="./vendor/venn.js/venn.js"></script>
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-73117681-1', 'auto');
  ga('send', 'pageview');

</script>

    <style>
      .fbg-tooltip {
        position: absolute;
        text-align: center;
        width: 128px;
        background: #333;
        color: #ddd;
        padding: 2px;
        border: 0px;
        border-radius: 8px;
        opacity: 0;
      }

      .select2-container--default .select2-results > .select2-results__options {
        max-height: 350px;
      }

      .fbg-text-bold {
        font-weight: bold;
        border-right: 1px solid lightgray;
      }
    </style>
  </head>
  <body>
    <nav class="navbar navbar-toggleable-md navbar-light bg-faded">
      <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <a class="navbar-brand" href="#">FB групи и сечения</a>

      <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <ul class="navbar-nav mr-auto">
          <!-- <li class="nav-item active">
            <a class="nav-link" href="#">Home</a>
          </li> -->
          <li class="nav-item">
            <a class="nav-link" href="#" data-toggle="modal" data-target="#fbg-dlg-about">За страницата</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#" data-toggle="modal" data-target="#fbg-dlg-programmers">За програмистите</a>
          </li>
        </ul>
      </div>
    </nav>
    <div class="container">
      <div class="row">
        <div class="col-md-4">
          <aside id="sidebar"></aside>
        </div>
        <div class="col-md-8">
          <div id="fbg-venn"></div>
        </div>
      </div>
      <div class="row">
        <div class="col-md-12">
          <div id="fbg-table">

          </div>
        </div>
      </div>
    </div>

    <div id="fbg-dlg-about" class="modal fade">
      <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">За страницата</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Затвори">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
<p>Приложениета "FB групи и множества" има за цел да представи фейсбук потребителите, които едновременно членуват в две или повече групи. Целта е да се сверят някои противоречия и зависимости между членовете на групи с подобни или противоположна идеология.</p>
<p>Събраните данни са идеални за занимаващи се със социология за проучване на нагласите на потребителите на най-голямата социална мрежа.</p>
<p>Интересни зависимости, които могат да се наблюдават с получените данни:</p>
<ul>
<li>1/15 от групата&nbsp;"<a href="https://www.facebook.com/groups/1068597903184746/" target="_blank">Фенове на Курволяци</a>" са членове на&nbsp;"<a href="https://www.facebook.com/groups/bulru/" target="_blank">БЪЛГАРИЯ - РУСИЯ FACEBOOK FRIENDS</a>".</li>
<li>25% от "<a href="https://www.facebook.com/groups/1504679289746034/" target="_blank">РПГ (Русофил-Путинистка Гвардия)</a>" са членове и на "<a href="https://www.facebook.com/groups/143366949008168/" target="_blank">ПРИЯТЕЛИ НА РУСИЯ - ДРУЗЬЯ РОССИИ</a>".</li>
<li>Голяма част от членовете на "<a href="https://www.facebook.com/groups/980371352022333/" target="_blank">NEMILI NE DRAGI</a>" и "<a href="https://www.facebook.com/groups/676780899106908/?fref=nf" target="_blank">KLETA MAJKA BALGARIA</a>" си съвпадат, тъй като двете групи са с тролски характер и техните членове може да се ползват за репер колко сериозни са тематиките на съответните групи, т.е. колко повече техни членове в съответната група, толкова по-вероятно групата е тролска.</li>
<li>"<a href="https://www.facebook.com/groups/376939412405555/" target="_blank">ДЕСЕН ПЪТ</a>" и "<a href="https://www.facebook.com/groups/demontirane/" target="_blank">Гражданска инициатива за демонтиране на паметника на съветската армия</a>" също си съвпадат с голям процент от потребителите си, предвид особената антисъветска реторика в тях.</li>
</ul>
<p style="text-align: justify;">Всички данни са изтеглени чрез API-тата на <a href="https://developers.facebook.com/" target="blank">facebook.com.</a> и нямат претенция за крайна изчерпателност.</p>
<p>Изходния код и данни са свободни за модификация и разпространение с MIT лиценз.</p>
<p><strong>Twitter:</strong> <a href="https://twitter.com/suricactus" target="blank">@suricactus</a></p>
<p><strong>Github:</strong> <a href="https://github.com/suricactus" target="blank">@suricactus</a></p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Затвори</button>
          </div>
        </div>
      </div>
    </div>

    <div id="fbg-dlg-programmers" class="modal fade">
      <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">За програмистите</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Затвори">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
<p>От доста години имам странна мания да колекционирам възможно най-абсурдните групи във фейсбук. Само част от тях са "<a href="https://www.facebook.com/groups/183101475126761/" target="_blank">ЗА възстановяване на петолъчката над Партийния дом!</a>, "<a href="https://www.facebook.com/groups/1504679289746034/?ref=br_rs" target="_blank">РПГ (Русофил-Путинистка Гвардия)</a>", "<a href="https://www.facebook.com/groups/575413325869832/" target="_blank">ИСТИНАТА Е НЯКЪДЕ ТАМ</a>" и прочие, чиито списък може да се види в настоящото приложение. С времето се зачудих дали наистина има 500 души, които искат да се върне петолъчката на сградата на Народното събрание и колко от тях са хардкор комунисти, срещани в другите съветофило-путинистко-комунистически групи.</p>
<p>Мина доста време от първите ми чудения по този въпрос, може би две или три, когато случайно попаднах на&nbsp;<a href="https://www.npmjs.com/package/facebook-export" target="_blank">facebook-export</a>&nbsp;модула в node. Отначало реших, че ще може идеално да изпълни целите ми, впоследствие открих, че не съвсем. За съжаление има проблеми със страницирането, а и&nbsp;запазването на информацията в ~ не ми хареса като идея.&nbsp;</p>
<p>Впоследствие погледнах API-то на facebook и открих, че възможността за изтегляне на данни за членовете на групи ще изчезне заедно в Graph API 2.2 и затова реших, че е крайно време да напиша съответния скрипт.</p>
<p>И така в крайна сметка спретнах простото скриптче:</p>
<ul>
<li>node скрипт за изтегляне на данните</li>
<li>sqlite за съхранението им в три таблици - fb_groups, fb_users и fb_groups_users</li>
<li>d3.js за визуализацията им с якия venn.js</li>
</ul>
<p>След това оставаше само да видя кои са припокриващите се множества от една група до друга група. Всичко щеше да е идеално, ако не се бях заблудил, че&nbsp;за да сметна потребителите на, които членуват във всяка отделна група ми трябват два cross join-а, което ми коства... над денонощия 100% CPU usage.</p>
<p>Тук е и цялата развръзка и поука. Какво бях измислил в началото:</p>
<pre>SELECT
  g1.id AS main_id,
  g1.name AS main_name,
  g2.id AS matching_id,
  &lt;SOME MAGIC HERE&gt; AS count_all,
  count(NULLIF(GU1.user_id = GU2.user_id, 0)) AS count_match
FROM fb_groups AS g1
JOIN fb_groups AS g2 ON g1.id &gt;= g2.id
JOIN fb_groups_users AS GU1 ON GU1.group_id = g1.id
LEFT JOIN fb_groups_users AS GU2 ON GU2.group_id = g2.id
WHERE 1 = 1
GROUP BY g1.id, g1.name, g2.id;</pre>
<p>Което естествено така и не успя да сработи. Опитах с подзаявка във from-а, но тогава sqlite-а гърмеше. След това имах гениална идея - нека да преизчисля count_all предварително в temp таблица и след това да се занимавам само с join-ите, но отново да са fb_groups^2 * fb_group_members^2, което на прост език ще рече 250^2*1000000^2 или&nbsp;62500000000000000 реда. Може да се предположи, че това отне трийсетина часа да се изпълни.</p>
<pre>DROP TABLE groups_with_totals;

CREATE TEMPORARY TABLE groups_with_totals (
  id int unique not null,
  name text not null,
  count_all int not null
);

INSERT INTO groups_with_totals (id, name, count_all)
  SELECT
    G0.id,
    G0.name,
    count(*) AS count_all
  FROM fb_groups AS G0
  JOIN fb_groups_users AS GU0 ON GU0.group_id = G0.id
  GROUP BY G0.id, G0.name;

SELECT
  g1.id AS main_id,
  g1.name AS main_name,
  g2.id AS matching_id,
  g1.count_all AS count_all,
  count(NULLIF(GU1.user_id = GU2.user_id, 0)) AS count_match
FROM groups_with_totals AS g1
JOIN fb_groups AS g2 ON g1.id &gt;= g2.id
JOIN fb_groups_users AS GU1 ON GU1.group_id = g1.id
LEFT JOIN fb_groups_users AS GU2 ON GU2.group_id = g2.id
WHERE 1 = 1
GROUP BY g1.id, g1.name, g2.id, g1.count_all;

</pre>
<p>В крайна сметка това работеше, но отнемаше ужасно много време. Тогава изведнъж ме озари идеята какво всъщност ми трябваше:</p>
<pre>SELECT
  g1.id AS main_id,
  g1.name AS main_name,
  g2.id AS matching_id,
  count(GU1.id) AS count_all1,
  count(GU2.id) AS count_match
FROM fb_groups AS g1
JOIN fb_groups AS g2 ON g1.id &gt;= g2.id
JOIN fb_groups_users AS GU1 ON GU1.group_id = g1.id
LEFT JOIN fb_groups_users AS GU2 ON GU2.group_id = g2.id AND GU1.user_id = GU2.user_id
WHERE 1 = 1
GROUP BY g1.id, g1.name, g2.id;
</pre>
<p>След тази промяна заявката се изпълнява за около 30 секунди, което никак ни е зле, предвид че преди това чаках няколко дни, за да се получи резултат. Като заключение мога да кажа, че понякога човек толкова се заблуждава в правотата на дадено решение, че съвсем изпуска прости оптимизации, които буквално могат да му спестят дни.</p>
<p>Всичко останало мисля, че е ясно, ако има някакви въпроси кода в <a href="https://github.com/suricactus/fb-group-members" target="_blank">github</a>&nbsp;е достатъчно описателен.</p>


>>>>>>> gh-pages
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Затвори</button>
          </div>
        </div>
      </div>
    </div>

    <script>
    const MAX_GROUPS_TO_COMPARE = 5;
    const $sidebar = $('#sidebar');
    const groups = {};

    d3.csv('../groups.csv', function(err, result) {
      if(err) {
        throw new Error(err);
      }

      for(let i = 0, l = result.length; i < l; i++) {
        const r = result[i];

        groups[ r.main_id ] = groups[ r.main_id ] || { relations: {}, };

        if(+r.main_id === +r.matching_id) {
          groups[ r.main_id ].data = {
            sets: [ +r.main_id ],
            label: r.main_name,
            size: +r.count_all,
          };
        } else {
          groups[ r.main_id ].relations[r.matching_id] = {
            sets: [ +r.main_id , +r.matching_id ],
            size: +r.count_match,
          };
        }
      }

      init();
    });

    function init() {
      generateSelects();

      $sidebar.on('change', 'select', (e) => {
        const vals = getSelectsVals();
        const sets = getSets(vals);
        const tblData = getTableData(vals);

        d3DrawVennDiagram(sets);
        d3DrawTable(tblData);
      });

    }

    function generateSelects() {
      const groupsArr = Object.values(groups).sort((a, b) => b.data.size - a.data.size);

      for(let i = 0; i < MAX_GROUPS_TO_COMPARE; i++) {
        const $select = $(`<select id="fbg-group-${ i }" class="form-control"></select>`);
        const $formGroup = $('<div class="form-group"></div>');

        $select.append(`<option value="">- няма избрано -</option>`);

        for(let j in groupsArr) {
          $select.append(`<option value="${ groupsArr[j].data.sets[0] }">${ groupsArr[j].data.label } (${ groupsArr[j].data.size })</option>`);
        }

        $formGroup.append(`<label for="fbg-group-${ i }">FB група ${ i + 1 }</label>`);
        $formGroup.append($select);

        $sidebar.append($formGroup);

        $select.select2();
      }

    }

    function getSelectsVals() {
      const vals = [];

      $sidebar.find('select').each((i, el) => {
        const val = $(el).val();

        if(val !== '') {
          vals.push(+val);
        }
      });

      vals.sort();

      return vals;
    }

    function getSets(vals) {
      const sets = [];

      for(let i = 0, l = vals.length; i < l; i++) {
        const groupId = vals[i];

        sets.push(groups[groupId].data);

        if(i == 0) {
          continue;
        }

        for(let j = i - 1; j >= 0; j--) {
          const matchingGroupId = vals[j];
          const biggerId = Math.max(matchingGroupId, groupId);
          const lesserId = Math.min(matchingGroupId, groupId);

          if(groups[biggerId].relations[lesserId]) {
            sets.push(groups[biggerId].relations[lesserId]);
          }
        }
      }

      return sets;
    }

    function getTableData(vals) {
      const tableData = [['']];
      const groupId2IndexMap = {};
      let groupId2IndexSeq = 1;

      for(let i = 0, l = vals.length; i < l; i++) {
        const groupId = vals[i];

        groupId2IndexMap[groupId] = (groupId2IndexMap[groupId] !== undefined) ? groupId2IndexMap[groupId] : groupId2IndexSeq++;

        tableData[0].push(groups[groupId].data.label);

        tableData[ groupId2IndexMap[groupId] ] = tableData[ groupId2IndexMap[groupId] ] || [];

        tableData[ groupId2IndexMap[groupId] ][0] = groups[groupId].data.label;

        tableData[ groupId2IndexMap[groupId] ][ groupId2IndexMap[groupId] ] = groups[groupId].data.size;

        for(let j = i; j >= 0; j--) {
          const matchingGroupId = vals[j];
          const biggerId = Math.max(matchingGroupId, groupId);
          const lesserId = Math.min(matchingGroupId, groupId);

          if(groups[biggerId].relations[lesserId]) {
            tableData[ groupId2IndexMap[groupId] ][ groupId2IndexMap[matchingGroupId] ] = groups[biggerId].relations[lesserId].size;
            tableData[ groupId2IndexMap[matchingGroupId] ][ groupId2IndexMap[groupId] ] = groups[biggerId].relations[lesserId].size;
          }
        }
      }

      return tableData;
    }

    function d3DrawVennDiagram(sets) {
      const div = d3.select('#fbg-venn');
      const chart = venn.VennDiagram()
                       .width(div.node().getBoundingClientRect().width)
                       .height(500);

      div.selectAll('*').remove();
      div.datum(sets).call(chart);

      const tooltip = d3.select('body').append('div')
          .attr('class', 'fbg-tooltip');

      div.selectAll('path')
          .style('stroke-opacity', 0)
          .style('stroke', '#fff')
          .style('stroke-width', 3)

      div.selectAll('g')
          .on('mouseover', function(d, i) {
              // sort all the areas relative to the current item
              venn.sortAreas(div, d);

              // Display a tooltip with the current size
              tooltip.transition().duration(400).style('opacity', .9);
              tooltip.text(d.size + ' users');

              // highlight the current path
              const selection = d3.select(this).transition('tooltip').duration(400);
              selection.select('path')
                  .style('fill-opacity', d.sets.length == 1 ? .4 : .1)
                  .style('stroke-opacity', 1);
          })

          .on('mousemove', function() {
              tooltip.style('left', (d3.event.pageX) + 'px')
                     .style('top', (d3.event.pageY - 28) + 'px');
          })

          .on('mouseout', function(d, i) {
              tooltip.transition().duration(400).style('opacity', 0);
              const selection = d3.select(this).transition('tooltip').duration(400);
              selection.select('path')
                  .style('fill-opacity', d.sets.length == 1 ? .25 : .0)
                  .style('stroke-opacity', 0);
          });
    }

    function d3DrawTable(tblData) {
      const tableContainer = d3.select('#fbg-table');
      const cols = tblData.shift();

      tableContainer.selectAll('*').remove();

      const table = tableContainer.append('table')
        .attr('class', 'table table-striped');

      table.append('thead').append('tr')
        .selectAll('th')
        .data(cols)
        .enter()
        .append('th')
        .text(d => d);

      const tr = table.append('tbody')
        .selectAll('tr')
        .data(tblData)
        .enter()
        .append('tr');

      const td = tr.selectAll('td')
        .data(d => d)
        .enter()
        .append('td')
        .attr('class', d => typeof d === 'string' ? 'fbg-text-bold' : '')
        .text(d => d)

    }



    </script>
  </body>
</html>
